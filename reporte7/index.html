<!DOCTYPE html>
<html lang="es">
	<head>
		<meta charset="utf-8" />
		<title>Cliente Unificado – Auth + Libros</title>
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<style>
			:root {
				--bg: #0f172a;
				--card: #111827;
				--muted: #94a3b8;
				--text: #e5e7eb;
				--accent: #22d3ee;
				--accent2: #60a5fa;
				--danger: #f87171;
				--ok: #34d399;
				--warn: #fbbf24;
				--border: #1f2937;
			}
			* {
				box-sizing: border-box;
			}
			body {
				margin: 0;
				background: linear-gradient(180deg, #0b1220, #0f172a 40%, #0b1220);
				color: var(--text);
				font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial;
			}
			header {
				padding: 24px 16px;
				border-bottom: 1px solid var(--border);
				background: rgba(17, 24, 39, 0.5);
				backdrop-filter: blur(6px);
				position: sticky;
				top: 0;
				z-index: 10;
			}
			.wrap {
				max-width: 1200px;
				margin: 0 auto;
				padding: 16px;
			}
			h1 {
				margin: 0;
				font-size: 20px;
				font-weight: 700;
			}
			.grid {
				display: grid;
				gap: 16px;
				grid-template-columns: repeat(12, 1fr);
			}
			.col-3 {
				grid-column: span 3;
			}
			.col-4 {
				grid-column: span 4;
			}
			.col-6 {
				grid-column: span 6;
			}
			.col-8 {
				grid-column: span 8;
			}
			.col-12 {
				grid-column: span 12;
			}
			@media (max-width: 900px) {
				.col-3,
				.col-4,
				.col-6,
				.col-8 {
					grid-column: span 12;
				}
			}
			.card {
				background: linear-gradient(180deg, #0f172a, #0b1220);
				border: 1px solid var(--border);
				border-radius: 16px;
				padding: 16px;
				box-shadow: 0 8px 30px rgba(0, 0, 0, 0.25);
			}
			.card h2 {
				font-size: 16px;
				margin: 0 0 8px;
			}
			.muted {
				color: var(--muted);
				font-size: 14px;
			}
			label {
				display: block;
				font-size: 13px;
				margin: 10px 0 6px;
				color: #cbd5e1;
			}
			input,
			select,
			textarea {
				width: 100%;
				padding: 10px 12px;
				border-radius: 10px;
				border: 1px solid var(--border);
				background: #0b1220;
				color: var(--text);
				outline: none;
			}
			input:focus,
			select:focus,
			textarea:focus {
				border-color: #334155;
				box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.15);
			}
			.row {
				display: flex;
				gap: 8px;
				align-items: center;
				flex-wrap: wrap;
			}
			.row-right {
				display: flex;
				gap: 8px;
				justify-content: flex-end;
				flex-wrap: wrap;
			}
			.btn {
				cursor: pointer;
				border: 1px solid var(--border);
				color: var(--text);
				background: linear-gradient(180deg, #0b1324, #09101f);
				padding: 10px 14px;
				border-radius: 10px;
				font-weight: 600;
			}
			.btn:hover {
				border-color: #334155;
				box-shadow: 0 8px 24px rgba(2, 132, 199, 0.15);
			}
			.btn.accent {
				border-color: rgba(34, 211, 238, 0.3);
			}
			.btn.ok {
				border-color: rgba(52, 211, 153, 0.3);
			}
			.btn.warn {
				border-color: rgba(251, 191, 36, 0.3);
			}
			.btn.danger {
				border-color: rgba(248, 113, 113, 0.3);
			}
			.badge {
				display: inline-block;
				padding: 4px 8px;
				border: 1px solid var(--border);
				border-radius: 999px;
				font-size: 12px;
				color: #cbd5e1;
			}
			.sep {
				height: 1px;
				background: var(--border);
				margin: 8px 0;
			}
			.small {
				font-size: 12px;
			}
			.mono {
				font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Courier New", monospace;
			}
			pre {
				margin: 0;
				padding: 12px;
				background: #0b1220;
				border: 1px solid var(--border);
				border-radius: 10px;
				overflow: auto;
				max-height: 240px;
				white-space: pre-wrap;
				word-break: break-word;
			}
			table {
				width: 100%;
				border-collapse: collapse;
			}
			th,
			td {
				border: 1px solid var(--border);
				padding: 8px;
				text-align: left;
			}
			th {
				background: #0b1220;
			}
			.pill {
				padding: 4px 8px;
				border: 1px solid var(--border);
				border-radius: 999px;
				font-size: 12px;
			}
		</style>
	</head>
	<body>
		<header>
			<div class="wrap row" style="justify-content: space-between">
				<div>
					<h1>Cliente Unificado – Auth + Libros</h1>
					<div class="muted small">JWT + Items + Catálogo de Libros (XML)</div>
				</div>
				<div class="row">
					<span class="badge">Auth: <span id="state-badge">Desconectado</span></span>
					<button id="btn-logout" class="btn danger" style="display: none">Cerrar sesión</button>
				</div>
			</div>
		</header>

		<main class="wrap">
			<!-- Config -->
			<section class="card col-12" style="margin-bottom: 16px">
				<h2>Configuración</h2>
				<div class="grid">
					<div class="col-4">
						<label>Auth Base URL (Puerto 5001)</label>
						<input id="authBase" placeholder="http://localhost:5001" />
					</div>
					<div class="col-4">
						<label>Libros Base URL (Puerto 5000)</label>
						<input id="booksBase" placeholder="http://localhost:5000" />
					</div>
					<div class="col-4">
						<label>&nbsp;</label>
						<div class="row">
							<button class="btn" id="saveBase">Guardar</button>
							<span class="muted small">Sirve este HTML desde 8080 para respetar CORS</span>
						</div>
					</div>
				</div>
				<div class="sep"></div>
				<div class="small muted">Tokens guardados en <span class="mono">localStorage</span> (solo dev).</div>
			</section>

			<!-- Auth -->
			<div class="grid">
				<section class="card col-6">
					<h2>Registro</h2>
					<label>Email</label><input id="regEmail" type="email" placeholder="alice@example.com" /> <label>Usuario</label><input id="regUser" placeholder="alice" /> <label>Contraseña</label
					><input id="regPass" type="password" placeholder="••••••••" />
					<div class="row-right" style="margin-top: 10px">
						<button id="btn-register" class="btn accent">Crear cuenta</button>
					</div>
				</section>

				<section class="card col-6">
					<h2>Iniciar sesión</h2>
					<label>Email o Usuario</label><input id="loginWho" placeholder="alice o alice@example.com" /> <label>Contraseña</label
					><input id="loginPass" type="password" placeholder="••••••••" />
					<div class="row-right" style="margin-top: 10px">
						<button id="btn-login" class="btn ok">Entrar</button>
					</div>
				</section>

				<section class="card col-12">
					<h2>Tokens</h2>
					<div class="grid">
						<div class="col-6">
							<div class="row" style="justify-content: space-between; align-items: center">
								<div class="muted small">Access Token</div>
								<button id="copy-access" class="btn small">Copiar</button>
							</div>
							<pre id="accessToken" class="mono muted">(vacío)</pre>
							<div class="small">Payload:</div>
							<pre id="accessPayload" class="mono muted">(vacío)</pre>
						</div>
						<div class="col-6">
							<div class="row" style="justify-content: space-between; align-items: center">
								<div class="muted small">Refresh Token</div>
								<button id="copy-refresh" class="btn small">Copiar</button>
							</div>
							<pre id="refreshToken" class="mono muted">(vacío)</pre>
							<div class="row" style="gap: 8px; margin-top: 8px">
								<button id="btn-refresh" class="btn warn">Refrescar Access</button>
								<span class="small muted">/auth/refresh</span>
							</div>
						</div>
					</div>
				</section>

				<section class="card col-6">
					<h2>Perfil (protegido)</h2>
					<div class="row" style="margin-bottom: 8px">
						<button id="btn-profile" class="btn">Obtener perfil</button>
					</div>
					<pre id="profileOut" class="mono muted">(sin datos)</pre>
				</section>

				<section class="card col-6">
					<h2>Items (protegido)</h2>
					<div class="row" style="gap: 12px; align-items: flex-end">
						<div style="flex: 1"><label>Título</label><input id="itemTitle" placeholder="Mi primer item" /></div>
						<div style="flex: 2"><label>Notas</label><input id="itemNotes" placeholder="texto..." /></div>
						<button id="btn-add-item" class="btn ok">Crear</button>
						<button id="btn-list-items" class="btn">Listar</button>
					</div>
					<div id="itemsList" class="list" style="margin-top: 8px"></div>
				</section>
			</div>

			<!-- Libros -->
			<section class="card col-12" style="margin-top: 16px">
				<h2>Catálogo de Libros (XML)</h2>
				<div class="grid">
					<div class="col-12">
						<div class="row" style="gap: 8px; margin-bottom: 8px">
							<button id="btn-books-all" class="btn">Listar todos</button>
							<div class="row">
								<input id="qIsbn" placeholder="ISBN" style="width: 200px" />
								<button id="btn-books-isbn" class="btn">Buscar ISBN</button>
							</div>
							<div class="row">
								<input id="qAuthor" placeholder="Autor" style="width: 220px" />
								<button id="btn-books-author" class="btn">Buscar autor</button>
							</div>
							<div class="row">
								<input id="qFormat" placeholder="Formato (Digital/Físico)" style="width: 220px" />
								<button id="btn-books-format" class="btn">Buscar formato</button>
							</div>
						</div>
						<div class="sep"></div>
					</div>

					<div class="col-12">
						<h3 style="margin: 8px 0">Resultados</h3>
						<div style="overflow: auto">
							<table id="booksTable">
								<thead>
									<tr>
										<th>ISBN</th>
										<th>Título</th>
										<th>Autor(es)</th>
										<th>Año</th>
										<th>Género</th>
										<th>Precio</th>
										<th>Stock</th>
										<th>Formato</th>
									</tr>
								</thead>
								<tbody id="booksTBody">
									<tr>
										<td colspan="8" class="muted small">(sin datos)</td>
									</tr>
								</tbody>
							</table>
						</div>
					</div>

					<div class="col-12">
						<h3 style="margin: 12px 0">Insertar libro</h3>
						<div class="grid">
							<div class="col-3"><label>ISBN</label><input id="insIsbn" /></div>
							<div class="col-3"><label>Título</label><input id="insTitulo" /></div>
							<div class="col-3"><label>Año</label><input id="insAnio" type="number" /></div>
							<div class="col-3"><label>Precio</label><input id="insPrecio" type="number" step="0.01" /></div>
							<div class="col-3"><label>Stock</label><input id="insStock" type="number" /></div>
							<div class="col-3"><label>Género</label><input id="insGenero" placeholder="Debe existir en tabla genero" /></div>
							<div class="col-3"><label>Formato</label><input id="insFormato" placeholder="Debe existir en tabla formato" /></div>
							<div class="col-6"><label>Autor(es)</label><input id="insAutor" placeholder="Separados por coma; deben existir" /></div>
							<div class="col-12 row-right" style="margin-top: 8px">
								<button id="btn-insert-book" class="btn ok">Insertar</button>
							</div>
						</div>
					</div>

					<div class="col-12">
						<h3 style="margin: 12px 0">Actualizar libro (por ISBN)</h3>
						<div class="grid">
							<div class="col-3"><label>ISBN</label><input id="updIsbn" /></div>
							<div class="col-3"><label>Título</label><input id="updTitulo" placeholder="(opcional)" /></div>
							<div class="col-3"><label>Año</label><input id="updAnio" type="number" placeholder="(opcional)" /></div>
							<div class="col-3"><label>Precio</label><input id="updPrecio" type="number" step="0.01" placeholder="(opcional)" /></div>
							<div class="col-3"><label>Stock</label><input id="updStock" type="number" placeholder="(opcional)" /></div>
							<div class="col-12 row-right" style="margin-top: 8px">
								<button id="btn-update-book" class="btn warn">Actualizar</button>
							</div>
						</div>
					</div>

					<div class="col-12">
						<h3 style="margin: 12px 0">Borrar libros (por lista de ISBNs)</h3>
						<div class="grid">
							<div class="col-8"><label>ISBNs separados por coma</label><input id="delIsbns" placeholder="978-0307743657, 978-0000000000" /></div>
							<div class="col-4 row-right" style="margin-top: 8px">
								<button id="btn-delete-books" class="btn danger">Borrar</button>
							</div>
						</div>
					</div>

					<div class="col-12">
						<h3 style="margin: 12px 0">Respuesta XML cruda</h3>
						<pre id="xmlRaw" class="mono muted">(sin respuesta)</pre>
					</div>
				</div>
			</section>

			<!-- Consola -->
			<section class="card col-12" style="margin-top: 16px">
				<h2>Consola</h2>
				<pre id="log" class="mono small muted">(mensajes)</pre>
			</section>
		</main>

		<script>
			// ======= Estado =======
			const el = (id) => document.getElementById(id);
			const state = {
				authBase: localStorage.getItem("authBase") || "http://172.206.106.38:5001",
				booksBase: localStorage.getItem("booksBase") || "http://172.206.106.38:5000",
				access: localStorage.getItem("access") || "",
				refresh: localStorage.getItem("refresh") || "",
			};
			const json = (x) => JSON.stringify(x, null, 2);

			// ======= Util =======
			function log(msg, typ = "info") {
				const now = new Date().toISOString();
				el("log").textContent = `${el("log").textContent}\n${now} ${typ.toUpperCase()}: ${msg}`.trim();
				el("log").scrollTop = el("log").scrollHeight;
			}
			function b64urlDecode(str) {
				try {
					str = str.replace(/-/g, "+").replace(/_/g, "/");
					const pad = str.length % 4;
					if (pad) str += "=".repeat(4 - pad);
					return atob(str);
				} catch {
					return "";
				}
			}
			function decodePayload(tok) {
				if (!tok || tok.split(".").length !== 3) return null;
				try {
					return JSON.parse(b64urlDecode(tok.split(".")[1]));
				} catch {
					return null;
				}
			}
			function setAuthUI() {
				el("authBase").value = state.authBase;
				el("booksBase").value = state.booksBase;
				el("accessToken").textContent = state.access || "(vacío)";
				el("refreshToken").textContent = state.refresh || "(vacío)";
				const p = decodePayload(state.access);
				el("accessPayload").textContent = p ? json(p) : "(vacío)";
				const badge = el("state-badge");
				const btnOut = el("btn-logout");
				if (state.access) {
					badge.textContent = "Autenticado";
					btnOut.style.display = "inline-block";
				} else {
					badge.textContent = "Desconectado";
					btnOut.style.display = "none";
				}
			}
			function saveState() {
				localStorage.setItem("authBase", state.authBase);
				localStorage.setItem("booksBase", state.booksBase);
				localStorage.setItem("access", state.access || "");
				localStorage.setItem("refresh", state.refresh || "");
				setAuthUI();
			}
			function copy(text) {
				navigator.clipboard
					.writeText(text || "")
					.then(() => log("Copiado"))
					.catch(() => log("No se pudo copiar", "err"));
			}
			function escapeHtml(s) {
				return (s || "").replace(/[&<>"'`=\/]/g, (c) => ({ "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#39;", "/": "&#x2F;", "`": "&#x60;", "=": "&#x3D;" }[c]));
			}

			// ======= Fetch con refresh auto (para /api/* de AUTH) =======
			async function apiFetchAuth(path, opts = {}, retry = true) {
				const url = state.authBase + path;
				const headers = Object.assign({ "Content-Type": "application/json" }, opts.headers || {});
				if (state.access) headers["Authorization"] = "Bearer " + state.access;
				const res = await fetch(url, Object.assign({}, opts, { headers }));
				if (res.status === 401 && retry && state.refresh) {
					log(`401 en ${path}, intentando refresh...`, "warn");
					const ok = await doRefresh();
					if (ok) return apiFetchAuth(path, opts, false);
				}
				return res;
			}

			// ======= Llamadas AUTH =======
			async function doRegister() {
				const email = el("regEmail").value.trim(),
					username = el("regUser").value.trim(),
					password = el("regPass").value;
				if (!email || !username || !password) return log("Registro: faltan campos", "err");
				const r = await fetch(state.authBase + "/auth/register", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ email, username, password }) });
				const j = await r.json().catch(() => ({}));
				if (!r.ok) return log(`Registro ERROR ${r.status} ${json(j)}`, "err");
				state.access = j.tokens?.access_token || "";
				state.refresh = j.tokens?.refresh_token || "";
				saveState();
				log(`Registro OK user=${j.user?.username}`);
			}
			async function doLogin() {
				const who = el("loginWho").value.trim(),
					password = el("loginPass").value;
				if (!who || !password) return log("Login: faltan campos", "err");
				const r = await fetch(state.authBase + "/auth/login", {
					method: "POST",
					headers: { "Content-Type": "application/json" },
					body: JSON.stringify({ email: who, username: who, password }),
				});
				const j = await r.json().catch(() => ({}));
				if (!r.ok) return log(`Login ERROR ${r.status} ${json(j)}`, "err");
				state.access = j.tokens?.access_token || "";
				state.refresh = j.tokens?.refresh_token || "";
				saveState();
				log(`Login OK user=${j.user?.username}`);
			}
			async function doRefresh() {
				if (!state.refresh) {
					log("No hay refresh", "err");
					return false;
				}
				const r = await fetch(state.authBase + "/auth/refresh", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ refresh_token: state.refresh }) });
				const j = await r.json().catch(() => ({}));
				if (!r.ok) {
					log(`Refresh ERROR ${r.status} ${json(j)}`, "err");
					doLogout(true);
					return false;
				}
				state.access = j.access_token || "";
				saveState();
				log("Access renovado");
				return true;
			}
			async function getProfile() {
				const r = await apiFetchAuth("/api/profile", { method: "GET" });
				const j = await r.json().catch(() => ({}));
				el("profileOut").textContent = json(j);
				r.ok ? log("Perfil OK") : log(`Perfil ERROR ${r.status}`, "err");
			}
			async function listItems() {
				const r = await apiFetchAuth("/api/items", { method: "GET" });
				const j = await r.json().catch(() => ({}));
				if (r.ok) {
					renderItems(j.items || []);
					log(`Items: ${(j.items || []).length}`);
				} else log(`Items ERROR ${r.status} ${json(j)}`, "err");
			}
			async function addItem() {
				const title = el("itemTitle").value.trim(),
					notes = el("itemNotes").value.trim();
				if (!title) return log("Debes poner un título", "err");
				const r = await apiFetchAuth("/api/items", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ title, notes }) });
				const j = await r.json().catch(() => ({}));
				if (r.ok) {
					log(`Item creado id=${j.id}`);
					el("itemTitle").value = "";
					el("itemNotes").value = "";
					listItems();
				} else log(`Crear item ERROR ${r.status} ${json(j)}`, "err");
			}
			function renderItems(list) {
				const box = el("itemsList");
				box.innerHTML = "";
				if (!Array.isArray(list) || !list.length) {
					box.innerHTML = '<div class="muted small">(sin items)</div>';
					return;
				}
				list.forEach((it) => {
					const d = document.createElement("div");
					d.className = "pill";
					d.textContent = `${it.id} • ${it.title} (${it.created_at})`;
					box.appendChild(d);
				});
			}
			function doLogout(silent = false) {
				state.access = "";
				state.refresh = "";
				saveState();
				if (!silent) log("Sesión cerrada");
			}

			// ======= Llamadas LIBROS (XML) =======
			async function fetchXML(path, opts = {}) {
				const url = state.booksBase + path;
				const r = await fetch(url, opts);
				const t = await r.text();
				el("xmlRaw").textContent = t;
				if (!r.ok) {
					log(`Libros ERROR ${r.status}`, "err");
					return null;
				}
				const doc = new DOMParser().parseFromString(t, "application/xml");
				// Si hay <response><status>…</status></response>
				const err = doc.querySelector("parsererror");
				if (err) {
					log("XML parse error", "err");
					return null;
				}
				return doc;
			}
			function xmlToRows(doc) {
				const rows = [];
				const books = doc.querySelectorAll("catalog > book");
				books.forEach((b) => {
					rows.push({
						isbn: b.getAttribute("isbn") || "",
						title: text(b, "title"),
						author: text(b, "author"),
						year: text(b, "year"),
						genre: text(b, "genre"),
						price: text(b, "price"),
						stock: text(b, "stock"),
						format: text(b, "format"),
					});
				});
				return rows;
			}
			function text(parent, tag) {
				const el = parent.querySelector(tag);
				return el ? el.textContent : "";
			}
			function renderBooksRows(rows) {
				const tb = el("booksTBody");
				tb.innerHTML = "";
				if (!rows.length) {
					tb.innerHTML = '<tr><td colspan="8" class="muted small">(sin datos)</td></tr>';
					return;
				}
				rows.forEach((r) => {
					const tr = document.createElement("tr");
					tr.innerHTML = `
          <td class="mono">${escapeHtml(r.isbn)}</td>
          <td>${escapeHtml(r.title)}</td>
          <td>${escapeHtml(r.author)}</td>
          <td>${escapeHtml(r.year)}</td>
          <td>${escapeHtml(r.genre)}</td>
          <td>${escapeHtml(r.price)}</td>
          <td>${escapeHtml(r.stock)}</td>
          <td>${escapeHtml(r.format)}</td>
        `;
					tb.appendChild(tr);
				});
			}

			async function booksAll() {
				const doc = await fetchXML("/api/books");
				if (!doc) return;
				renderBooksRows(xmlToRows(doc));
				log("Libros: todos");
			}
			async function booksByIsbn() {
				const isbn = el("qIsbn").value.trim();
				if (!isbn) return log("ISBN vacío", "err");
				const doc = await fetchXML("/api/books/isbn/" + encodeURIComponent(isbn));
				if (!doc) return;
				renderBooksRows(xmlToRows(doc));
				log("Libros: por ISBN");
			}
			async function booksByAuthor() {
				const a = el("qAuthor").value.trim();
				if (!a) return log("Autor vacío", "err");
				const doc = await fetchXML("/api/books/author/" + encodeURIComponent(a));
				if (!doc) return;
				renderBooksRows(xmlToRows(doc));
				log("Libros: por autor");
			}
			async function booksByFormat() {
				const f = el("qFormat").value.trim();
				if (!f) return log("Formato vacío", "err");
				const doc = await fetchXML("/api/books/format/" + encodeURIComponent(f));
				if (!doc) return;
				renderBooksRows(xmlToRows(doc));
				log("Libros: por formato");
			}

			async function insertBook() {
				// Este endpoint espera JSON y regresa XML de mensaje
				const payload = {
					isbn: el("insIsbn").value.trim(),
					titulo: el("insTitulo").value.trim(),
					anio_publicacion: +el("insAnio").value || null,
					precio: parseFloat(el("insPrecio").value) || 0,
					stock: +el("insStock").value || 0,
					genero: el("insGenero").value.trim(),
					formato: el("insFormato").value.trim(),
					autor: el("insAutor").value.trim(),
				};
				if (!payload.isbn || !payload.titulo) return log("Insertar: faltan campos clave", "err");
				const r = await fetch(state.booksBase + "/api/books/insert", {
					method: "POST",
					headers: { "Content-Type": "application/json" },
					body: JSON.stringify(payload),
				});
				const t = await r.text();
				el("xmlRaw").textContent = t;
				if (!r.ok) {
					log(`Insertar ERROR ${r.status}`, "err");
					return;
				}
				log("Libro insertado");
				booksAll();
			}

			async function updateBook() {
				const isbn = el("updIsbn").value.trim();
				if (!isbn) return log("Actualizar: ISBN vacío", "err");
				const body = {};
				const titulo = el("updTitulo").value.trim();
				if (titulo) body.titulo = titulo;
				const anio = el("updAnio").value.trim();
				if (anio) body.anio_publicacion = +anio;
				const precio = el("updPrecio").value.trim();
				if (precio) body.precio = parseFloat(precio);
				const stock = el("updStock").value.trim();
				if (stock) body.stock = +stock;
				if (Object.keys(body).length === 0) return log("Nada que actualizar", "err");
				const r = await fetch(state.booksBase + "/api/books/update/" + encodeURIComponent(isbn), {
					method: "PUT",
					headers: { "Content-Type": "application/json" },
					body: JSON.stringify(body),
				});
				const t = await r.text();
				el("xmlRaw").textContent = t;
				r.ok ? log("Libro actualizado") : log(`Actualizar ERROR ${r.status}`, "err");
				booksByIsbn();
			}

			async function deleteBooks() {
				const list = el("delIsbns")
					.value.split(",")
					.map((s) => s.trim())
					.filter(Boolean);
				if (!list.length) return log("Borrar: lista vacía", "err");
				const r = await fetch(state.booksBase + "/api/books/delete", {
					method: "DELETE",
					headers: { "Content-Type": "application/json" },
					body: JSON.stringify({ isbns: list }),
				});
				const t = await r.text();
				el("xmlRaw").textContent = t;
				r.ok ? log("Libros borrados") : log(`Borrar ERROR ${r.status}`, "err");
				booksAll();
			}

			// ======= UI events =======
			el("saveBase").addEventListener("click", () => {
				state.authBase = el("authBase").value.trim() || "http://localhost:5001";
				state.booksBase = el("booksBase").value.trim() || "http://localhost:5000";
				saveState();
				log(`Bases: auth=${state.authBase} libros=${state.booksBase}`);
			});
			el("btn-register").addEventListener("click", doRegister);
			el("btn-login").addEventListener("click", doLogin);
			el("btn-refresh").addEventListener("click", doRefresh);
			el("btn-profile").addEventListener("click", getProfile);
			el("btn-add-item").addEventListener("click", addItem);
			el("btn-list-items").addEventListener("click", listItems);
			el("btn-logout").addEventListener("click", () => doLogout(false));
			el("copy-access").addEventListener("click", () => copy(state.access));
			el("copy-refresh").addEventListener("click", () => copy(state.refresh));

			el("btn-books-all").addEventListener("click", booksAll);
			el("btn-books-isbn").addEventListener("click", booksByIsbn);
			el("btn-books-author").addEventListener("click", booksByAuthor);
			el("btn-books-format").addEventListener("click", booksByFormat);
			el("btn-insert-book").addEventListener("click", insertBook);
			el("btn-update-book").addEventListener("click", updateBook);
			el("btn-delete-books").addEventListener("click", deleteBooks);

			// ======= Init =======
			setAuthUI();
			log("Cliente listo: configura URLs y prueba endpoints.", "ok");
		</script>
	</body>
</html>
